name: Composer outdated

on:
  schedule:
    - cron: '0 5 * * 0'
  workflow_dispatch:

env:
  PHP_VERSION: 8.2

jobs:
  composer-outdated:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout latest tag
        id: checkout-latest-tag
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 #v6.0.0
        with:
          node-version: '24'
        
      - name: Install GitHub Copilot CLI
        run: |
          echo "Installing GitHub Copilot CLI at $(date)"
          npm install -g @github/copilot
          
      - name: Create composer cache
        id: create-composer-cache
        uses: ./.github/actions/composer-cache

      - name: Set up PHP
        uses: shivammathur/setup-php@bf6b4fbd49ca58e4608c9c89fba0b8d90bd2a39f #v2.35.5
        with:
          php-version: '${{ env.PHP_VERSION }}' 

      - name: Composer install modules
        id: composer-install
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          composer install --no-dev --no-ansi --no-interaction --no-progress --no-suggest

      - name: Check for outdated packages
        id: composer-outdated
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          composer outdated --direct --format=json > outdated.json
          echo "text<<EOF" >> $GITHUB_OUTPUT
          jq -r '.installed[] | select(.version != .latest) | "- \(.name)@\(.version) â†’ \(.latest)"' outdated.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Use outdated packages list
        run: |
          echo "Outdated packages:"
          echo "${{ steps.composer-outdated.outputs.text }}"

      - name: Set current date
        id: date
        run: echo "date=$(date +%Y-%m-%d-%H:%M)" >> $GITHUB_OUTPUT

      - name: GitHub Copilot analyze composer outdated
        id: copilot-analyze
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_CI }}
        run: |
          copilot --version
          gh auth login
          copilot -p "Houston, we have a problem" --allow-all-tools 
          #Analyze composer outdated output ./outdated.json" \
          #and create issue ,Composer outdated modules check [${{ steps.date.outputs.date }}], \
          #add labels dependencies,module,outdated and assignees ${{ github.repository_owner }}" --allow-all-tools 
