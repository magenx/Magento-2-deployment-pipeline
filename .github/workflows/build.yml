name: "Magento complete build"

on:
  release:
    types: [published]

env:
  PRELELEASE_TYPE: ${{ vars.PRERELEASE_TYPE }}

concurrency:
  group: build
  cancel-in-progress: true

jobs:
  build:
    if: "${{ github.event.release.prerelease == true }}"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout latest tag
        id: checkout-latest-tag
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Composer cache
        id: composer-cache
        uses: ./.github/actions/composer-cache

      - name: Magento compilation setup:di:compile
        id: compile
        uses: ./.github/actions/setup-di-compile
        with:
          composer_auth: "${{ secrets.COMPOSER_AUTH }}"
          composer_install: "--no-ansi --no-dev --no-interaction --no-progress"
          composer_autoload: "--optimize --classmap-authoritative"
          setup_di_compile: "-n --no-ansi"
          static_content_deploy: "-f -n --no-ansi -j $(nproc)"
          debug_command: "bin/magento"

      - name: Call a security-scan action
        id: security-scan
        if: ${{ !cancelled() }}
        uses: ./.github/actions/security-scan
        with:
          ecomscan_key: ${{ secrets.ECOMSCAN_KEY }}

      - name: Set version for complete build
        id: set-build-version
        run: |
          echo "ARTIFACT_NAME=release_$(date +%Y%m%d%H%M)-${{ github.event.release.tag_name }}.tar.gz" >> ${GITHUB_ENV}

      - name: Package build artifact into tar archive
        id: tar-artifact
        run: | 
          tar --ignore-failed-read --warning=no-file-changed \
            -czf "${{ env.ARTIFACT_NAME }}" \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="app/etc/env.php" \
            --exclude="CHANGELOG*" \
            --exclude="${{ env.ARTIFACT_NAME }}" \
            .

      - name: Upload pre-release build artifact
        id: upload-artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 #v5.0.0
        with:
          name: "${{ env.ARTIFACT_NAME }}"
          overwrite: true
          path: ${{ env.ARTIFACT_NAME }}

      - name: Attach build artifact link to this pre-release information
        id: artifact-link-to-release
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe #v2.4.2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          append_body: true
          body: |
            -- 
            âœ… Link to pre-release build artifact:
            ${{ env.ARTIFACT_NAME }}
            ${{ steps.upload-artifact.outputs.artifact-url }}
          
      - name: Construct status message for PR comment
        if: ${{ !cancelled() }}
        id: construct-comment
        run: |
          COMMENT=""
          declare -A job_icons=( ["success"]="ðŸŸ¢" ["failure"]="ðŸ”´" ["cancelled"]="âš«" )
          COMMENT+="${job_icons[${{ job.status }}]} BUILD STATUS: ${{ job.status }}\n\n"
          
          declare -A step_icons=( ["success"]="âœ”ï¸" ["failure"]="âŒ" ["skipped"]="âž–" ["cancelled"]="âœ–ï¸" )
          COMMENT+="${step_icons[${{ steps.compile.outputs.composer_install }}]} Composer install ${{ steps.compile.outputs.composer_install }}\n"
          COMMENT+="${step_icons[${{ steps.compile.outputs.setup_di_compile }}]} Code compilation ${{ steps.compile.outputs.setup_di_compile }}\n"
          COMMENT+="${step_icons[${{ steps.compile.outputs.composer_autoload }}]} Composer autoload ${{ steps.compile.outputs.composer_autoload }}\n"
          COMMENT+="${step_icons[${{ steps.compile.outputs.hyva_theme }}]} Hyva theme generation ${{ steps.compile.outputs.hyva_theme }}\n"
          COMMENT+="${step_icons[${{ steps.compile.outputs.static_content_deploy }}]} Static content deploy ${{ steps.compile.outputs.static_content_deploy }}\n"
          COMMENT+="${step_icons[${{ steps.compile.outputs.debug }}]} Debug command ${{ steps.compile.outputs.debug }}\n"
          COMMENT+="${step_icons[${{ steps.tar-artifact.outcome }}]} Create archive for artifact ${{ steps.tar-artifact.outcome }}\n"
          COMMENT+="${step_icons[${{ steps.upload-artifact.outcome }}]} Upload artifact ${{ steps.upload-artifact.outcome }}\n"
          
          if [ "${{ job.status }}" == "success" ]; then
            COMMENT+="\n## Build and artifact details:\n"
            COMMENT+="- **ARTIFACT_ID**: ${{ steps.upload-artifact.outputs.artifact-id }}\n"
            COMMENT+="- **ARTIFACT_NAME**: ${{ env.ARTIFACT_NAME }}\n"
            COMMENT+="- **ARTIFACT_DIGEST**: ${{ steps.upload-artifact.outputs.artifact-digest }}\n"
            COMMENT+="- **ARTIFACT_URL**: ${{ steps.upload-artifact.outputs.artifact-url }}\n"
            COMMENT+="- **RUN_ID**: ${GITHUB_RUN_ID}\n"
            COMMENT+="- **RUN_URL**: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\n"
          fi
          
          COMMENT+="\n@${GITHUB_REPOSITORY_OWNER} Please review this PR.\n"
          
          echo -e "${COMMENT}" > comment.txt

      - name: Find PR for production release
        id: find-pr
        if: ${{ !cancelled() }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number=$(gh pr list \
            --repo "${GITHUB_REPOSITORY}" \
            --state open \
            --label "autorelease: pending" \
            --search "-in:title ${PRELELEASE_TYPE}" \
            --json number \
            --limit 1 \
            --jq '.[0].number')
          echo "pr_number=$pr_number" >> ${GITHUB_OUTPUT}

      - name: Add status to PR for production release
        id: add-pr-comment
        if: ${{ !cancelled() }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: | 
          gh pr comment ${{ steps.find-pr.outputs.pr_number }} \
            --repo "${GITHUB_REPOSITORY}" \
            --body-file comment.txt

      - name: Trigger pre-release deployment workflow
        id: payload
        uses: peter-evans/repository-dispatch@5fc4efd1a4797ddb68ffd0714a238564e4cc0e6f #v4.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: deployment
          client-payload: |-
            {
              "environment": "staging",
              "artifact_name": "${{ env.ARTIFACT_NAME }}",
              "artifact_url": "${{ steps.upload-artifact.outputs.artifact-url }}",
              "artifact_digest": "${{ steps.upload-artifact.outputs.artifact-digest }}",
              "artifact_run_id" : "${{ github.run_id }}",
              "tag_name": "${{ github.event.release.tag_name }}"
            }

      - name: Rename pre-release artifact tag to release ready artifact
        id: rename-artifact
        run: |
          artifact="${{ env.ARTIFACT_NAME }}"
          new_artifact="${artifact%-*}.tar.gz"
          mv "$artifact" "$new_artifact"
          echo "ARTIFACT_NAME=$new_artifact" >> ${GITHUB_ENV}

      - name: Upload release build artifact
        id: upload-release-artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 #v5.0.0
        with:
          name: "${{ env.ARTIFACT_NAME }}"
          overwrite: true
          path: ${{ env.ARTIFACT_NAME }}
