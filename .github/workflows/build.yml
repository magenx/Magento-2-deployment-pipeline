name: "Magento Build Workflow"

on:
  pull_request:
    types: 
      - opened
      - labeled
      - edited
      - synchronize

jobs:
  build:
    if: "${{ contains(github.event.pull_request.labels.*.name, 'autorelease: pending') && contains(github.event.pull_request.title, 'alpha') }}"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout latest tag
        id: checkout-latest-tag
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Composer cache
        id: composer-cache
        uses: ./.github/actions/composer-cache

      - name: Magento compilation setup:di:compile
        id: compile
        uses: ./.github/actions/setup-di-compile
        with:
          composer_auth: "${{ secrets.COMPOSER_AUTH }}"
          composer_options: "--optimize-autoloader --apcu-autoloader"
          setup_compile_options: ""
          static_content_deploy: true
          static_content_deploy_options: ""
          debug_command: "bin/magento"

      - name: Set version for complete build
        id: set-build-version
        run: | 
          echo "ARTIFACT_NAME=$(date +%Y%m%d%H%M).tar.gz" >> ${GITHUB_ENV}

      - name: Package build into tar archive
        id: tar-archive
        run: | 
          tar --ignore-failed-read --warning=no-file-changed \
            -czf "${{ env.ARTIFACT_NAME }}" \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="app/etc/env.php" \
            --exclude="CHANGELOG*" \
            --exclude="${{ env.ARTIFACT_NAME }}" \
            .

      - name: Upload build artifact
        id: upload-artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #v4.6.2
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}
          
      - name: Construct PR comment
        if: ${{ !cancelled() }}
        id: construct-comment
        run: |
          COMMENT=""
          declare -A job_icons=( ["success"]="🟢" ["failure"]="🔴" ["cancelled"]="⚫" )
          COMMENT+="${job_icons[${{ job.status }}]} BUILD STATUS: ${{ job.status }}\n\n"
          
          declare -A step_icons=( ["success"]="✔️" ["failure"]="❌" ["skipped"]="➖" ["cancelled"]="✖️" )
          COMMENT+="${step_icons[${{ steps.compile.outputs.composer_install_status }}]} Composer install ${{ steps.compile.outputs.composer_install_status }}\n"
          COMMENT+="${step_icons[${{ steps.compile.outputs.setup_di_compile_status }}]} Code compilation ${{ steps.compile.outputs.setup_di_compile_status }}\n"
          COMMENT+="${step_icons[${{ steps.compile.outputs.static_content_deploy_status }}]} Static content deploy ${{ steps.compile.outputs.static_content_deploy_status }}\n"
          COMMENT+="${step_icons[${{ steps.compile.outputs.debug_status }}]} Debug command ${{ steps.compile.outputs.debug_status }}\n"
          
          if [ "${{ job.status }}" == "success" ]; then
            COMMENT+="\n## Build and artifact details:\n"
            COMMENT+="- **ARTIFACT_ID**: ${{ steps.upload-artifact.outputs.artifact-id }}\n"
            COMMENT+="- **RUN_ID**: ${GITHUB_RUN_ID}\n"
            COMMENT+="- **ARTIFACT_NAME**: ${{ env.ARTIFACT_NAME }}\n"
            COMMENT+="- **RUN_URL**: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\n"
            COMMENT+="- **ARTIFACT_URL**: ${{ steps.upload-artifact.outputs.artifact-url }}\n"
          fi
          
          COMMENT+="\n@${GITHUB_REPOSITORY_OWNER} Please review this PR.\n"
          
          echo -e "${COMMENT}" > comment.txt

      - name: Add comment to PR
        id: add-pr-comment
        if: ${{ !cancelled() }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: | 
          gh pr comment ${{ github.event.pull_request.number }} --repo "${GITHUB_REPOSITORY}" --body-file comment.txt

