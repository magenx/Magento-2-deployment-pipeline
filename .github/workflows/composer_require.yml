name: Composer require and lock check

on:
  pull_request:
    types:
      - opened
      - synchronize
    paths:
      - "composer.json"

env:
  PHP_VERSION: 8.2

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  composer-install-validate:
    if: "${{ ! startsWith(github.head_ref, 'release-please') || ! contains(github.event.pull_request.labels.*.name, 'autorelease: pending') }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@0f7f1d08e3e32076e51cae65eb0b0c871405b16e #v2.34.1
        with:
          php-version: '${{ env.PHP_VERSION }}'

      - name: Create composer cache
        id: create-composer-cache
        uses: ./.github/actions/composer-cache

      - name: Composer require diff
        id: composer-diff
        uses: ./.github/actions/composer-diff
        with:
          base_ref: ${{ github.event.pull_request.base.ref }}
          base_path: "base"

      - name: Composer require dependencies
        id: composer-require
        if: ${{ steps.composer-diff.outputs.require == 'true' && steps.composer-diff.outputs.update != 'true' }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          while read module; do
            composer require "$module" --no-install
          done < require.txt

      - name: Composer remove dependencies
        id: composer-remove
        if: ${{ steps.composer-diff.outputs.remove == 'true' }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          while read module; do
            composer remove "$module" --no-update
          done < remove.txt

      - name: Composer install dependencies
        id: composer-install
        if: ${{ steps.composer-diff.outputs.update != 'true' }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          composer install --no-dev --no-ansi --no-interaction --no-progress

      - name: Composer update all
        id: composer-update
        if: ${{ steps.composer-diff.outputs.update == 'true' }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          composer update -W --no-dev --no-ansi --no-interaction --no-progress

      - name: Composer lock diff and Magento module extract
        id: composer-lock-diff
        uses: ./.github/actions/composer-lock-diff
        with:
          base_path: "base"

      - name: Enable newly installed modules
        id: module-enable
        if: ${{ steps.composer-lock-diff.outputs.magento_modules != '' }}
        run: |
          modules=$(awk '{print $1}' magento_modules.txt | xargs)
          bin/magento module:enable $modules -n --no-ansi -q 2>/dev/null || true

      - name: Magento compilation setup:di:compile
        id: compile
        uses: ./.github/actions/setup-di-compile
        with:
          composer_auth: ""
          composer_install: ""
          composer_autoload: ""
          setup_di_compile: "-n --no-ansi"
          static_content_deploy: ""
          debug_command: "bin/magento"

      - name: Check for config.php changes
        id: git-diff-config
        if: ${{ steps.composer-lock-diff.outputs.locked == 'true' }}
        run: |
          echo "config_changed=$(git diff --quiet app/etc/config.php && echo false || echo true)" >> "${GITHUB_OUTPUT}"

      - name: Commit updated config.php back to PR branch
        id: config-commit
        if: ${{ steps.git-diff-config.outputs.config_changed == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@778341af668090896ca464160c2def5d1d1a3eb0 #v6.0.1
        with:
          commit_message: "chore(config): Update app/etc/config.php after module enable"
          file_pattern: app/etc/config.php

      - name: Commit updated composer.lock back to PR branch
        id: composer-lock-commit
        if: ${{ steps.composer-diff.outputs.require == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@778341af668090896ca464160c2def5d1d1a3eb0 #v6.0.1
        with:
          commit_message: "chore(composer): Update composer.lock to match composer.json"
          file_pattern: composer.lock

      - uses: reviewdog/action-setup@e04ffabe3898a0af8d0fb1af00c188831c4b5893 #v1.3.2
        with:
          reviewdog_version: v0.20.3

      - name: Composer require review comment to PR
        id: package-require-comment-pr
        if: ${{ steps.composer-diff.outputs.require == 'true' }}
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODULES=$(awk '{printf "- **%s**<br>", $0}' require.txt | sed 's/ $//')
          printf "composer.json: %s" "<br>$MODULES" \
          | reviewdog -efm="%f: %m" \
            -name="COMPOSER PACKAGES REQUIRE:" \
            -reporter=github-pr-review \
            -filter-mode=nofilter \
            -level=info

      - name: Composer remove review comment to PR
        id: package-remove-comment-pr
        if: ${{ steps.composer-diff.outputs.remove == 'true' }}
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODULES=$(awk '{printf "- **%s**<br>", $0}' remove.txt | sed 's/ $//')
          printf "composer.json: %s" "<br>$MODULES" \
          | reviewdog -efm="%f: %m" \
            -name="COMPOSER PACKAGES REMOVE:" \
            -reporter=github-pr-review \
            -filter-mode=nofilter \
            -level=info

      - name: Composer lock review comment to PR
        id: package-lock-comment-pr
        if: ${{ steps.composer-lock-diff.outputs.locked == 'true' }}
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODULES=$(awk '{printf "- **%s**<br>", $0}' locked.txt | sed 's/ $//')
          printf "composer.lock: %s" "<br>$MODULES" \
          | reviewdog -efm="%f: %m" \
            -name="INCLUDING A REQUIRED DEPENDENCY:" \
            -reporter=github-pr-review \
            -filter-mode=nofilter \
            -level=warning
