name: Composer require and lock check

on:
  pull_request:
    types:
      - opened
      - synchronize
    paths:
      - "composer.json"

env:
  PHP_VERSION: 8.2

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  composer-install-validate:
    if: "${{ ! startsWith(github.head_ref, 'release-please') || ! contains(github.event.pull_request.labels.*.name, 'autorelease: pending') }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@bf6b4fbd49ca58e4608c9c89fba0b8d90bd2a39f #v2.35.5
        with:
          php-version: '${{ env.PHP_VERSION }}'

      - name: Create composer cache
        id: create-composer-cache
        uses: ./.github/actions/composer-cache

      - name: Composer require diff
        id: composer-diff
        uses: ./.github/actions/composer-diff
        with:
          base_ref: ${{ github.event.pull_request.base.ref }}
          base_path: "base"

      - name: Composer require dependencies
        id: composer-require
        if: ${{ steps.composer-diff.outputs.require == 'true' && steps.composer-diff.outputs.update != 'true' }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          while read module; do
            composer require "$module" --no-install
          done < require.txt

      - name: Composer remove dependencies
        id: composer-remove
        if: ${{ steps.composer-diff.outputs.remove == 'true' }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          while read module; do
            composer remove "$module" --no-update
          done < remove.txt

      - name: Composer install dependencies
        id: composer-install
        if: ${{ steps.composer-diff.outputs.update != 'true' }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          composer install --no-dev --no-ansi --no-interaction --no-progress

      - name: Composer update all
        id: composer-update
        if: ${{ steps.composer-diff.outputs.update == 'true' }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          composer update -W --no-dev --no-ansi --no-interaction --no-progress

      - name: Composer lock diff and Magento module extract
        id: composer-lock-diff
        uses: ./.github/actions/composer-lock-diff
        with:
          base_path: "base"

      - name: Enable newly installed modules
        id: module-enable
        if: ${{ steps.composer-lock-diff.outputs.magento_modules != '' }}
        run: |
          modules=$(awk '{print $1}' magento_modules.txt | xargs)
          bin/magento module:enable $modules -n --no-ansi -q 2>/dev/null || true

      - name: Magento compilation setup:di:compile
        id: compile
        uses: ./.github/actions/setup-di-compile
        with:
          composer_auth: ""
          composer_install: ""
          composer_autoload: ""
          setup_di_compile: "-n --no-ansi"
          static_content_deploy: ""
          debug_command: "bin/magento"

      - name: Check for config.php changes
        id: git-diff-config
        if: ${{ steps.composer-lock-diff.outputs.locked == 'true' }}
        run: |
          echo "config_changed=$(git diff --quiet app/etc/config.php && echo false || echo true)" >> "${GITHUB_OUTPUT}"

      - name: Commit updated config.php back to PR branch
        id: config-commit
        if: ${{ steps.git-diff-config.outputs.config_changed == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 #v7.0.0
        with:
          commit_message: "chore(config): Update app/etc/config.php after module enable"
          file_pattern: app/etc/config.php

      - name: Commit updated composer.lock back to PR branch
        id: composer-lock-commit
        if: ${{ steps.composer-diff.outputs.require == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 #v7.0.0
        with:
          commit_message: "chore(composer): Update composer.lock to match composer.json"
          file_pattern: composer.lock

      - name: Composer require review comment to PR
        if: ${{ steps.composer-diff.outputs.require == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODULES_REQUIRE=$(awk '{printf "- **%s**\n", $0}' require.txt)
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo "${GITHUB_REPOSITORY}" \
            --body "## COMPOSER PACKAGES REQUIRE:
          > composer.json:
          $MODULES_REQUIRE"
      
      - name: Composer remove review comment to PR
        if: ${{ steps.composer-diff.outputs.remove == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODULES_REMOVE=$(awk '{printf "- **%s**\n", $0}' remove.txt)
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo "${GITHUB_REPOSITORY}" \
            --body "## COMPOSER PACKAGES REMOVE:
          > composer.json:
          $MODULES_REMOVE"
      
      - name: Composer lock review comment to PR
        if: ${{ steps.composer-lock-diff.outputs.locked == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODULES_DEPENDENCY=$(awk '{printf "- **%s**\n", $0}' locked.txt)
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo "${GITHUB_REPOSITORY}" \
            --body "## INCLUDING A REQUIRED DEPENDENCY:
          > composer.lock:
          $MODULES_DEPENDENCY"
